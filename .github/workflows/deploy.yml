name: Deploy to Production

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag to deploy (leave empty for latest)'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: vreshch/vreshch.com

jobs:
  build-and-push:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Determine image tag
        id: set-tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.tag }}" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Using custom tag: ${{ inputs.tag }}"
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Using commit SHA: ${{ github.sha }}"
          fi

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ Build and push Docker image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          TAG="${{ steps.set-tag.outputs.tag }}"
          
          echo "ğŸ—ï¸ Building image..."
          docker build -t ${IMAGE}:${TAG} -t ${IMAGE}:latest .
          
          echo "ğŸ“¤ Pushing image..."
          docker push ${IMAGE}:${TAG}
          docker push ${IMAGE}:latest
          
          echo "âœ… Image pushed successfully!"
          echo "ğŸ“¦ Image: ${IMAGE}:${TAG}"
          echo "ğŸ“¦ Image: ${IMAGE}:latest"

  deploy:
    name: ğŸš€ Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Copy deployment files to server
        run: |
          echo "ğŸ“¦ Copying docker-compose.yml..."
          scp -i ~/.ssh/deploy_key docker-compose.yml root@${{ secrets.SERVER_HOST }}:/opt/vreshch-com/
          
          echo "ğŸ“¦ Copying deployment script..."
          scp -i ~/.ssh/deploy_key scripts/deploy.sh root@${{ secrets.SERVER_HOST }}:/opt/vreshch-com/
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_HOST }} "chmod +x /opt/vreshch-com/deploy.sh"

      - name: ğŸš€ Deploy application
        id: deploy
        run: |
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
          
          echo "ğŸš€ Deploying to production..."
          echo "ğŸ“¦ Image tag: ${IMAGE_TAG}"
          
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_HOST }} << EOF
            set -e
            cd /opt/vreshch-com
            
            # Update image tag in docker-compose
            sed -i "s|image:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}|g" docker-compose.yml
            
            # Deploy to Docker Swarm
            echo "ğŸ³ Deploying stack..."
            docker stack deploy -c docker-compose.yml vreshch --with-registry-auth
            
            # Wait for deployment
            echo "â³ Waiting for service to be ready..."
            sleep 15
            
            # Check service status
            echo "âœ… Service status:"
            docker service ps vreshch_web --no-trunc --format "table {{.Name}}\t{{.CurrentState}}\t{{.Error}}"
            
            # Save deployed version
            echo "${IMAGE_TAG}" > .deployed-version
            echo "âœ… Deployment complete!"
          EOF

      - name: âœ… Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          
          # Wait a bit more for service to be fully ready
          sleep 10
          
          # Check if website is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L https://vreshch.com || echo "000")
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… Website is accessible (HTTP $HTTP_CODE)"
            echo "deployment-status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Website returned HTTP $HTTP_CODE"
            echo "deployment-status=warning" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸŒ Production URL: https://vreshch.com"

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          echo "ğŸ§¹ Cleanup complete"

  deployment-summary:
    name: ğŸ“‹ Deployment Summary
    needs: [build-and-push, deploy]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“Š Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const buildResult = '${{ needs.build-and-push.result }}';
            const deployResult = '${{ needs.deploy.result }}';
            const imageTag = '${{ needs.build-and-push.outputs.image-tag }}';
            const commitSha = '${{ github.sha }}';
            const commitMessage = `${{ github.event.head_commit.message }}` || 'Manual deployment';
            
            let status = 'âœ… SUCCESS';
            let emoji = 'ğŸ‰';
            
            if (buildResult === 'failure') {
              status = 'âŒ FAILED - Build';
              emoji = 'ğŸ”¨';
            } else if (deployResult === 'failure') {
              status = 'âŒ FAILED - Deployment';
              emoji = 'ğŸš¨';
            }
            
            const summary = `${emoji} **Deployment ${status}**
            
            **Commit:** \`${commitSha.substring(0, 8)}\`
            **Message:** ${commitMessage}
            **Branch:** master
            **Trigger:** ${{ github.event_name === 'workflow_dispatch' ? 'Manual' : 'Automatic (push)' }}
            
            **Pipeline Results:**
            - ğŸ³ Build & Push: ${buildResult === 'success' ? 'âœ…' : 'âŒ'} ${buildResult}
            - ğŸš€ Deployment: ${deployResult === 'success' ? 'âœ…' : 'âŒ'} ${deployResult}
            
            **Details:**
            - **Image Tag:** \`${imageTag}\`
            - **Registry:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
            - **Server:** 128.140.118.245 (vreshch.com)
            - **Deployment URL:** https://vreshch.com
            
            **Quick Actions:**
            - ğŸ“‹ [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - ğŸŒ [Visit Website](https://vreshch.com)
            - ğŸ“¦ [Registry](https://github.com/${{ github.repository }}/pkgs/container/vreshch.com)
            
            ---
            â° Generated at: \`${new Date().toISOString()}\``;
            
            console.log(summary);
            
            // Create commit status
            try {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: commitSha,
                state: deployResult === 'success' ? 'success' : 'failure',
                target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
                description: `Deployment ${status}`,
                context: 'deployment/production'
              });
            } catch (error) {
              console.log('Could not create commit status:', error.message);
            }
